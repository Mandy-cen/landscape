<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>city night view</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #101010;
        }

        .container {
            width: 100%;
            height: 100%;
            margin-top: 0;
            margin-left: 0;
            position: relative;
        }

        .container > canvas{
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div id="landscape" class="container"></div>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script>
        var RENDERER1 = {
            BUILDING_COUNT : 20,
            CAR_COUNT : 5,
            BASE_Y_RATE : 2 / 3,
            OFFSET_Y : 5,

            init: function () {
                this.setParameters()
                this.setup()
                this.reconstructMethods()
                this.render()
                return this;
            },
            setParameters: function () {
                this.$container = $('#landscape')
                this.width = this.$container.width()
                this.height = this.$container.height()
                this.$canvas = $('<canvas />').attr({width: this.width, height: this.height}).appendTo(this.$container)
                this.contex = this.$canvas.get(0).getContext('2d')
                this.baseY = this.height * this.BASE_Y_RATE
                this.buildings = []
                this.cars = []
                this.brightness = 0
            },

            setup: function () {
                this.buildings.length = 0
                this.cars.length = 0
                this.baseY = this.height * this.BASE_Y_RATE;
                this.brightness = 0
                this.width = this.$container.width()
                this.height = this.$container.height()
                this.$canvas.attr({width: this.width, height: this.height})
                this.createElements()
            },
            createElements: function () {
                for(var i = 0, length = this.BUILDING_COUNT * this.width / 500; i < length; i++){
                    this.buildings.push(new BUILDING(this))
                }
            },
            reconstructMethods : function(){
//                this.render = this.render.bind(this);
            },
            getRandomValue: function (min, max, weight) {
                return min + Math.round((max - min) * Math.pow(Math.random(), weight))
            },
            render: function () {
                for(var i = 0, length = this.buildings.length; i < length; i++) {
                    this.buildings[i].render(this.contex, (this.brightness + 1) / 2)
                }
            }
        }

        // 建筑物
        var BUILDING = function (renderer) {
            this.renderer = renderer
            this.init(false)
        }

        BUILDING.prototype = {
            FOCUS_POSITION: 500,
            FAR_LIMIT: 800,
            WINDOW_RATE: 0.8,
            LIGHT_RATE: 0.3,
            VELOCITY: 0.2,
            
            init: function (toReset) {
                this.setParameters(toReset);
                this.createObjects()
            },
            
            setParameters: function (toReset) {
                this.x = toReset ? this.renderer.width : this.renderer.getRandomValue(-this.renderer.width, this.renderer.width, 1)
                this.y = this.renderer.OFFSET_Y
                this.z = this.renderer.getRandomValue(0, this.FAR_LIMIT, 1)
                this.vx = -this.VELOCITY
                this.height = Math.round(this.renderer.getRandomValue(this.renderer.height / 8, this.renderer.baseY, 4) / 10) * 10
                this.width = Math.round(this.renderer.height / 6 * Math.sqrt(this.height / this.renderer.height) / 10) * 10
                this.y += this.height
                this.offsetX = 0
                this.hue = this.renderer.getRandomValue(220, 260, 1);
                this.windows = []
                this.lights = []
            },
            createObjects: function () {
//                let axis = this.getAxis()
//                console.log(axis)
            },
            getAxis: function () {
                var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION)
                return {x: this.x * rate, y: -this.y * rate, width: this.width * rate, height: this.height * rate, rate: rate}
            },
            render: function (context, brightness) {
                var axis = this.getAxis();
                this.offsetX += this.vx * axis.rate

                if(axis.x + this.offsetX > this.renderer.width / 2) {
                    return
                } else if (axis.x + axis.width + this.renderer.width / 2 + this.offsetX < 0) {
                    this.init()
                    return
                }

                context.save();
                context.translate(this.renderer.width / 2 + this.offsetX, this.renderer.baseY);

                for(var i = -0.5; i <= 1; i += 1.5) {
                    context.save()
                    context.scale(1, i)

                    var gradient = context.createLinearGradient(axis.x, axis.y, axis.x, axis.y + axis.height);
                    gradient.addColorStop(0, 'hsl(' + this.hue + ', ' + (30 + 30 * i) + '%, ' + 30 * axis.rate * brightness + '%)');
                    gradient.addColorStop(1, 'hsl(' + this.hue + ', ' + (30 + 30 * i) + '%, ' + 5 * axis.rate * brightness + '%)');
                    context.fillStyle = gradient;
                    context.fillRect(axis.x, axis.y, axis.width, axis.height);

                    for(var j = 0, length = this.windows.length; j < length; j++){
                        this.windows[j].render(context);
                    }
                    for(var j = 0, length = this.lights.length; j < length; j++){
                        this.lights[j].render(context);
                    }
                    context.restore();

                }
                context.restore();
            }
        }

        $(function () {
            RENDERER1.init()
        })
    </script>
</body>
</html>